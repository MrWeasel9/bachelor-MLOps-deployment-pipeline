apiVersion: v1
kind: Pod
metadata:
  name: model-builder
  namespace: mlops
  # Add annotation to prevent Istio sidecar injection
  annotations:
    sidecar.istio.io/inject: "false"
spec:
  containers:
  - name: builder
    image: python:3.10-slim
    command:
      - "sh"
      - "-c"
      - |
        set -ex
        pip install "mlflow[mlserver]==2.14.3" boto3

        # 1. Build the Docker image from the specified run
        mlflow models build-docker \
          -m "runs:/<your_new_run_id>/model" \
          -n "mrweasel9/mlflow-wine-classifier" \
          --enable-mlserver

        # 2. Login to Docker Hub
        echo "OregonTrail#1883" | docker login --username "mrweasel9" --password-stdin

        # 3. Push the image
        docker push "mrweasel9/mlflow-wine-classifier"

        echo "Build and push complete!"
    envFrom:
    - secretRef:
        name: aws-s3-credentials
    env:
    - name: MLFLOW_TRACKING_URI
      value: "http://mlflow:5000"
    - name: MLFLOW_S3_ENDPOINT_URL
      value: "http://minio:9000"
    volumeMounts:
    - name: docker-sock
      mountPath: /var/run/docker.sock
  volumes:
  - name: docker-sock
    hostPath:
      path: /var/run/docker.sock
  restartPolicy: OnFailure