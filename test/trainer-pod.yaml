apiVersion: v1
kind: Pod
metadata:
  name: model-trainer
  namespace: mlops
  # This annotation tells Istio to ignore this pod, as it's a short-lived job.
  annotations:
    sidecar.istio.io/inject: "false"
spec:
  # THIS IS THE FIX: An initContainer waits for the MLflow service to be
  # fully healthy before the main trainer container starts.
  initContainers:
  - name: wait-for-mlflow
    image: busybox:1.36
    command:
      - "sh"
      - "-c"
      - |
        echo "Waiting for MLflow service to be ready..."
        # This command repeatedly tries to connect to MLflow's health endpoint.
        # It will only succeed and allow the pod to continue once MLflow is active.
        until wget -q --spider -T 10 http://mlflow:5000/health; do
          echo "MLflow not ready yet, sleeping for 5 seconds..."
          sleep 5
        done
        echo "MLflow is ready! Proceeding with training."
  containers:
  - name: trainer
    image: python:3.10-slim
    command:
      - "sh"
      - "-c"
      - |
        set -ex
        # Install dependencies
        pip install "mlflow[mlserver]==2.14.3" scikit-learn

        # Run the training and tuning scripts
        echo "--- Running baseline training ---"
        python /scripts/train_wine_model.py

        echo "--- Running hyperparameter tuning ---"
        python /scripts/hyperparameter_tuning.py

        echo "--- Training complete. Check logs for new run IDs. ---"
    envFrom:
    - secretRef:
        name: aws-s3-credentials
    env:
    # Set variables for MLflow server and MinIO artifact store
    - name: MLFLOW_TRACKING_URI
      value: "http://mlflow:5000"
    - name: MLFLOW_S3_ENDPOINT_URL
      value: "http://minio:9000"
    volumeMounts:
    - name: scripts-volume
      mountPath: /scripts
  volumes:
  - name: scripts-volume
    configMap:
      name: training-scripts
  restartPolicy: OnFailure